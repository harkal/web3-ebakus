/*!
 * Extend Web3 for Ebakus Blockchain v0.1.7
 * 
 * @author Ebakus AG <hello@ebakus.com>
 * @website https://www.ebakus.com/
 * 
 * @copyright Ebakus 2020
 * @license MIT
 */
!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports["web3-ebakus-subprovider"]=r():e.Web3EbakusSubprovider=r()}(this,(function(){return function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=26)}([function(e,r){e.exports=require("eth-lib/lib/bytes")},function(e,r){e.exports=require("eth-lib/lib/rlp")},function(e,r){e.exports=require("core-js/modules/es6.object.to-string")},function(e,r){e.exports=require("regenerator-runtime/runtime")},function(e,r){e.exports=require("core-js/modules/es6.symbol")},function(e,r){e.exports=require("core-js/modules/es6.promise")},function(e,r){e.exports=require("eth-lib/lib/account")},function(e,r){e.exports=require("eth-lib/lib/hash")},function(e,r,t){(function(r){e.exports=function(){return new r("./node_modules/web3-ebakus/lib/proofOfWork.node.worker.js")}}).call(this,t(24).Worker)},function(e,r){e.exports=require("core-js/modules/es7.object.get-own-property-descriptors")},function(e,r){e.exports=require("core-js/modules/web.dom.iterable")},function(e,r){e.exports=require("core-js/modules/es6.array.iterator")},function(e,r){e.exports=require("core-js/modules/es6.object.keys")},function(e,r){e.exports=require("core-js/modules/es6.regexp.to-string")},function(e,r){e.exports=require("core-js/modules/es7.symbol.async-iterator")},function(r,t,n){"use strict";n.r(t),n(14),n(4),n(3),n(5),n(13),n(2);var o,a=n(0),u=n.n(a),c=n(1),i=n.n(c),s=n(8),l=n.n(s),f=(n(25),function(e){return("string"==typeof e||"number"==typeof e)&&/^(-)?0x[0-9a-f]*$/i.test(e)});function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}n.d(t,"createCalculateWorkForTransaction",(function(){return m})),n.d(t,"benchmarkWorkCallsPerSecond",(function(){return d}));var m=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=function(r){return e.hexToNumber?e.hexToNumber(r):parseInt(r,16)},t=function(r){return e.numberToHex?e.numberToHex(r):"0x".concat(r.toString(16))};return function(n,o,a,c){var s=!1;return c=c||function(){},n?Promise.resolve(function(n){var s,m,d,b,g,h,y,x;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:if(s=0,m=!1,null!==a&&"object"===p(a)&&(a.isRunning=function(){return m},a.getCurrentWorkNonce=function(){return s},a.kill=function(){m=!1,s=0,d&&d.terminate(),b&&b("Worker terminated by user")}),v.prev=3,o){v.next=12;break}if(!e.suggestDifficulty){v.next=11;break}return v.next=8,regeneratorRuntime.awrap(e.suggestDifficulty(n.from));case 8:o=v.sent,v.next=12;break;case 11:g=new Error("Ebakus calculateWorkForTransaction - opts.suggestDifficulty not provided");case 12:if(n.nonce||g){v.next=20;break}if(!e.getTransactionCount){v.next=19;break}return v.next=16,regeneratorRuntime.awrap(e.getTransactionCount(n.from));case 16:n.nonce=v.sent,v.next=20;break;case 19:g=new Error("Ebakus calculateWorkForTransaction - opts.getTransactionCount not provided");case 20:if(n.gas||g){v.next=28;break}if(!e.estimateGas){v.next=27;break}return v.next=24,regeneratorRuntime.awrap(e.estimateGas(n));case 24:n.gas=v.sent,v.next=28;break;case 27:g=new Error("Ebakus calculateWorkForTransaction - opts.estimateGas not provided");case 28:if(!g){v.next=31;break}return c(g),v.abrupt("return",Promise.reject(g));case 31:return n.gasPrice="0",e.inputCallFormatter&&(n=e.inputCallFormatter(n)),h=i.a.encode([u.a.fromNat(n.nonce),u.a.fromNat(n.gas),n.to?n.to.toLowerCase():"",u.a.fromNat(n.value||"0x"),n.data||"0x"]),y=f(n.gas)?r(n.gas):n.gas,x={hash:h,targetDifficulty:o*y},v.abrupt("return",new Promise((function(e,r){d=new l.a,b=r,d.on("message",(function(r){var o=r.cmd,a=r.workNonce;switch(o){case"ready":m=!0,d.postMessage(x);break;case"current":s=a;break;case"finished":n.workNonce=t(a),s=n.workNonce,m=!1,d.terminate(),c(null,n),e(n);break;default:console.warn("Unknown data from worker",r)}})),d.on("error",(function(e){throw e})),d.on("exit",(function(e){if(1===e)return null;var r=new Error("Worker has stopped with code ".concat(e));return c(r),Promise.reject(r)}))})));case 39:return v.prev=39,v.t0=v.catch(3),c(v.t0),v.abrupt("return",Promise.reject(v.t0));case 43:case"end":return v.stop()}}),null,null,[[3,39]])}(n)):(s=new Error("No transaction object given!"),c(s),Promise.reject(s))}},d=function(r){return o&&o>0?Promise.resolve(o):(r=r||function(){},Promise.resolve(regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,n={benchmark:!0},a.abrupt("return",new Promise((function(a){(t=new l.a).on("message",(function(u){var c=u.cmd,i=u.callsPerSecond;switch(c){case"ready":t.postMessage(n);break;case"finished":t.terminate(),o=i,r(null,i),a(i);break;default:console.warn("Unknown data from worker",e.data)}})),t.on("error",(function(e){throw e})),t.on("exit",(function(e){if(1===e)return null;var t=new Error("Worker has stopped with code ".concat(e));return r(t),Promise.reject(t)}))})));case 5:return a.prev=5,a.t0=a.catch(0),r(a.t0),a.abrupt("return",Promise.reject(a.t0));case 9:case"end":return a.stop()}}),null,null,[[0,5]])));var t,n}},function(e,r){e.exports=require("util")},function(e,r){e.exports=require("web3-provider-engine/subproviders/subprovider")},function(e,r){e.exports=require("eth-lib/lib/nat")},function(e,r){e.exports=require("core-js/modules/es6.string.iterator")},function(e,r){e.exports=require("core-js/modules/es6.regexp.replace")},function(e,r){e.exports=require("core-js/modules/es6.string.starts-with")},function(e,r){e.exports=require("core-js/modules/es6.number.constructor")},function(e,r){e.exports=require("core-js/modules/es6.math.log2")},function(e,r){e.exports=require("worker_threads")},function(e,r){e.exports=require("core-js/modules/es6.typed.uint8-array")},function(e,r,t){"use strict";t.r(r),t(9),t(4),t(10),t(11),t(2),t(12),t(3);var n,o=t(16),a=t(17),u=t.n(a),c=(t(13),t(14),t(19),t(5),t(20),t(21),t(6)),i=t.n(c),s=t(0),l=t.n(s),f=t(7),p=t.n(f),m=t(18),d=t.n(m),b=t(1),g=t.n(b);function h(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function y(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?h(Object(t),!0).forEach((function(r){x(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):h(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function x(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var v,w=function(e){return null==e},k=function(e){for(;e&&e.startsWith("0x0");)e="0x".concat(e.slice(3));return e},j=function(e){return e.length%2==1&&(e=e.replace("0x","0x0")),e},O=function(e,r,t){var o,a,u,c;return regeneratorRuntime.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(u=function(e){if((e.nonce<0||e.gas<0||e.workNonce<0||e.chainId<0)&&(o=new Error("Nonce, gas, workNonce or chainId is lower than 0")),o)return t(o),Promise.reject(o);try{var u=n.extend.formatters.inputCallFormatter(e);u.to=u.to||"0x",u.data=u.data||"0x",u.value=u.value||"0x",u.chainId=n.utils.numberToHex(u.chainId);var c=g.a.encode([l.a.fromNat(u.nonce),l.a.fromNat(u.workNonce||"0x"),l.a.fromNat(u.gas),u.to.toLowerCase(),l.a.fromNat(u.value),u.data,l.a.fromNat(u.chainId||"0x1"),"0x","0x"]),s=p.a.keccak256(c),f=i.a.makeSigner(2*d.a.toNumber(u.chainId||"0x1")+35)(p.a.keccak256(c),r),m=g.a.decode(c).slice(0,6).concat(i.a.decodeSignature(f));m[6]=j(k(m[6])),m[7]=j(k(m[7])),m[8]=j(k(m[8]));var b=g.a.encode(m),h=g.a.decode(b);a={messageHash:s,v:k(h[6]),r:k(h[7]),s:k(h[8]),rawTransaction:b}}catch(e){return t(e),Promise.reject(e)}return t(null,a),a},o=!1,t=t||function(){},e){s.next=7;break}return o=new Error("No transaction object given!"),t(o),s.abrupt("return",Promise.reject(o));case 7:if(e.gasPrice="0",void 0===e.nonce||void 0===e.gas||void 0===e.workNonce||void 0===e.chainId){s.next=10;break}return s.abrupt("return",Promise.resolve(u(e)));case 10:return c=n.eth.accounts.privateKeyToAccount(r).address,s.abrupt("return",Promise.all([w(e.nonce)?n.eth.getTransactionCount(c):e.nonce,w(e.gas)?n.eth.estimateGas(e):e.gas,w(e.workNonce)?n.eth.calculateWorkForTransaction(y({},e,{from:c})):e,w(e.chainId)?n.eth.getChainId():e.chainId]).then((function(r){var t,n,o=(n=4,function(e){if(Array.isArray(e))return e}(t=r)||function(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],n=!0,o=!1,a=void 0;try{for(var u,c=e[Symbol.iterator]();!(n=(u=c.next()).done)&&(t.push(u.value),!r||t.length!==r);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==c.return||c.return()}finally{if(o)throw a}}return t}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()),a=o[0],c=o[1],i=o[2].workNonce,s=o[3];if(w(a)||w(c)||w(i)||w(s))throw new Error("One of the values 'nonce=".concat(a,"', 'gas=").concat(c,"', 'workNonce=").concat(i,"' or 'chainId=").concat(s,"' couldn't be fetched"));return u(y({},e,{nonce:a,gas:c,workNonce:i,chainId:s}))})));case 12:case"end":return s.stop()}}))};t(22),t(23),v=t(15).benchmarkWorkCallsPerSecond;var P,T=function(){var e,r,t,n,o,a,u,c=arguments;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return e=c.length>0&&void 0!==c[0]?c[0]:2,r=c.length>1&&void 0!==c[1]?c[1]:21e3,(t=c.length>2?c[2]:void 0)||"function"==typeof(n=Array.prototype.slice.call(c))[n.length-1]&&(t=n.pop()),t=t||function(){},i.prev=5,i.next=8,regeneratorRuntime.awrap(v());case 8:return o=i.sent,a=Math.log2(e*r),a=Math.ceil(a),u=Number((a/o*1e4%60).toFixed(2)),t(null,u),i.abrupt("return",Promise.resolve(u));case 16:return i.prev=16,i.t0=i.catch(5),t(i.t0),i.abrupt("return",Promise.reject(i.t0));case 20:case"end":return i.stop()}}),null,null,[[5,16]])};P=t(15).createCalculateWorkForTransaction;var F=function(e){if(!e)throw new Error("No web3 object provided to web3-ebakus!");e.eth.extend({methods:[{name:"suggestDifficulty",call:"eth_suggestDifficulty",params:1,inputFormatter:[e.utils.toChecksumAddress],outputFormatter:e.utils.toFloat},{name:"getAbiForAddress",call:"eth_getAbiForAddress",params:1,inputFormatter:[e.utils.inputAddressFormatter]},{name:"getStaked",call:"eth_getStaked",params:2,inputFormatter:[e.utils.inputAddressFormatter,e.utils.inputBlockNumberFormatter]}]}),e.extend({property:"db",methods:[{name:"get",call:"db_get",params:5,inputFormatter:[e.utils.inputAddressFormatter,null,null,null,e.utils.inputBlockNumberFormatter]},{name:"select",call:"db_select",params:5,inputFormatter:[e.utils.inputAddressFormatter,null,null,null,e.utils.inputBlockNumberFormatter]},{name:"next",call:"db_next",params:1,inputFormatter:[null]},{name:"releaseIterator",call:"db_releaseIterator",params:1,inputFormatter:[null]}]});var r=P({suggestDifficulty:e.eth.suggestDifficulty,getTransactionCount:e.eth.getTransactionCount,estimateGas:e.eth.estimateGas,hexToNumber:e.utils.hexToNumber,numberToHex:e.utils.numberToHex,inputCallFormatter:e.extend.formatters.inputCallFormatter});e.eth.calculateWorkForTransaction=r,e.eth.estimatePoWTime=T;var t=e.eth.accounts.__proto__._addAccountFunctions;return e.eth.accounts.__proto__._addAccountFunctions=function(r){return(r=t.call(this,r)).signTransaction=function(e,t){return O(e,r.privateKey,t)},r.calculateWorkForTransaction=e.eth.calculateWorkForTransaction,r},e.eth.accounts.signTransaction=function(e,r,t){return O(e,r,t)},n=e,e};function N(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function _(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}t.d(r,"default",(function(){return q}));var S={defaultTargetDifficulty:null};function q(e){var r=function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?N(Object(t),!0).forEach((function(r){_(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):N(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}({},S,{},e),t=r.web3,n=r.defaultTargetDifficulty;this.web3=new F(t),this.defaultTargetDifficulty=n}Object(o.inherits)(q,u.a),q.prototype.handleRequest=function(e,r,t){var n,o,a;return regeneratorRuntime.async((function(u){for(;;)switch(u.prev=u.next){case 0:u.t0=e.method,u.next="eth_sendTransaction"===u.t0?3:"eth_signTransaction"===u.t0?3:"eth_getTransactionReceipt"===u.t0?20:22;break;case 3:if((n=e.params[0]).workNonce){u.next=18;break}return u.prev=5,u.next=8,regeneratorRuntime.awrap(this.web3.eth.calculateWorkForTransaction(n,this.defaultTargetDifficulty,null));case 8:o=u.sent,a=o.workNonce,e.params[0].workNonce=a,e.params[0].gasPrice=a,u.next=18;break;case 14:return u.prev=14,u.t1=u.catch(5),t(u.t1),u.abrupt("return");case 18:return r(),u.abrupt("return");case 20:return setTimeout((function(){r()}),1500),u.abrupt("return");case 22:return r(),u.abrupt("return");case 24:case"end":return u.stop()}}),null,this,[[5,14]])}}]).default}));