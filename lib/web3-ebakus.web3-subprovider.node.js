/*!
 * Extend Web3 for Ebakus Blockchain v0.1.9
 * 
 * @author Ebakus AG <hello@ebakus.com>
 * @website https://www.ebakus.com/
 * 
 * @copyright Ebakus 2020
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["web3-ebakus-subprovider"]=t():e.Web3EbakusSubprovider=t()}(this,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=15)}([function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("eth-lib/lib/bytes")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("eth-lib/lib/rlp")},function(e,t){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,t){e.exports=require("eth-lib/lib/account")},function(e,t){e.exports=require("eth-lib/lib/hash")},function(e,t,r){(function(t){e.exports=function(){return new t("./node_modules/web3-ebakus/lib/proofOfWork.node.worker.js")}}).call(this,r(14).Worker)},function(t,r,n){"use strict";n.r(r);var o,a=n(0),c=n.n(a),u=n(13),i=n.n(u),s=n(2),l=n.n(s),f=n(1),p=n.n(f),b=n(3),d=n.n(b),m=n(7),h=n.n(m),g=function(e){return("string"==typeof e||"number"==typeof e)&&/^(-)?0x[0-9a-f]*$/i.test(e)};n.d(r,"createCalculateWorkForTransaction",(function(){return v})),n.d(r,"benchmarkWorkCallsPerSecond",(function(){return k}));var v=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=function(t){return e.hexToNumber?e.hexToNumber(t):parseInt(t,16)},r=function(t){return e.numberToHex?e.numberToHex(t):"0x".concat(t.toString(16))};return function(n,o,a,u){var s=!1;if(u=u||function(){},!n)return s=new Error("No transaction object given!"),u(s),Promise.reject(s);var f=function(){var n=l()(c.a.mark((function n(s){var l,f,b,m,v,k,x,w;return c.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(l=0,f=!1,null!==a&&"object"===i()(a)&&(a.isRunning=function(){return f},a.getCurrentWorkNonce=function(){return l},a.kill=function(){f=!1,l=0,b&&b.terminate(),m&&m("Worker terminated by user")}),n.prev=3,o){n.next=12;break}if(!e.suggestDifficulty){n.next=11;break}return n.next=8,e.suggestDifficulty(s.from);case 8:o=n.sent,n.next=12;break;case 11:v=new Error("Ebakus calculateWorkForTransaction - opts.suggestDifficulty not provided");case 12:if(s.nonce||v){n.next=20;break}if(!e.getTransactionCount){n.next=19;break}return n.next=16,e.getTransactionCount(s.from);case 16:s.nonce=n.sent,n.next=20;break;case 19:v=new Error("Ebakus calculateWorkForTransaction - opts.getTransactionCount not provided");case 20:if(s.gas||v){n.next=28;break}if(!e.estimateGas){n.next=27;break}return n.next=24,e.estimateGas(s);case 24:s.gas=n.sent,n.next=28;break;case 27:v=new Error("Ebakus calculateWorkForTransaction - opts.estimateGas not provided");case 28:if(!v){n.next=31;break}return u(v),n.abrupt("return",Promise.reject(v));case 31:return s.gasPrice="0",e.inputCallFormatter&&(s=e.inputCallFormatter(s)),k=d.a.encode([p.a.fromNat(s.nonce),p.a.fromNat(s.gas),s.to?s.to.toLowerCase():"",p.a.fromNat(s.value||"0x"),s.data||"0x"]),x=g(s.gas)?t(s.gas):s.gas,w={hash:k,targetDifficulty:o*x},n.abrupt("return",new Promise((function(e,t){b=new h.a,m=t,b.on("message",(function(t){var n=t.cmd,o=t.workNonce;switch(n){case"ready":f=!0,b.postMessage(w);break;case"current":l=o;break;case"finished":s.workNonce=r(o),l=s.workNonce,f=!1,b.terminate(),u(null,s),e(s);break;default:console.warn("Unknown data from worker",t)}})),b.on("error",(function(e){throw e})),b.on("exit",(function(e){if(1===e)return null;var t=new Error("Worker has stopped with code ".concat(e));return u(t),Promise.reject(t)}))})));case 39:return n.prev=39,n.t0=n.catch(3),u(n.t0),n.abrupt("return",Promise.reject(n.t0));case 43:case"end":return n.stop()}}),n,null,[[3,39]])})));return function(e){return n.apply(this,arguments)}}();return Promise.resolve(f(n))}},k=function(t){if(o&&o>0)return Promise.resolve(o);t=t||function(){};var r=function(){var r=l()(c.a.mark((function r(){var n,a;return c.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,a={benchmark:!0},r.abrupt("return",new Promise((function(r){(n=new h.a).on("message",(function(c){var u=c.cmd,i=c.callsPerSecond;switch(u){case"ready":n.postMessage(a);break;case"finished":n.terminate(),o=i,t(null,i),r(i);break;default:console.warn("Unknown data from worker",e.data)}})),n.on("error",(function(e){throw e})),n.on("exit",(function(e){if(1===e)return null;var r=new Error("Worker has stopped with code ".concat(e));return t(r),Promise.reject(r)}))})));case 5:return r.prev=5,r.t0=r.catch(0),t(r.t0),r.abrupt("return",Promise.reject(r.t0));case 9:case"end":return r.stop()}}),r,null,[[0,5]])})));return function(){return r.apply(this,arguments)}}();return Promise.resolve(r())}},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("web3-provider-engine/subproviders/subprovider")},function(e,t){e.exports=require("@babel/runtime/helpers/slicedToArray")},function(e,t){e.exports=require("eth-lib/lib/nat")},function(e,t){e.exports=require("@babel/runtime/helpers/typeof")},function(e,t){e.exports=require("worker_threads")},function(e,t,r){"use strict";r.r(t);var n,o=r(0),a=r.n(o),c=r(2),u=r.n(c),i=r(4),s=r.n(i),l=r(9),f=r(10),p=r.n(f),b=r(11),d=r.n(b),m=r(5),h=r.n(m),g=r(1),v=r.n(g),k=r(6),x=r.n(k),w=r(12),y=r.n(w),j=r(3),P=r.n(j);function O(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function T(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?O(Object(r),!0).forEach((function(t){s()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):O(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var F,N=function(e){return null==e},_=function(e){for(;e&&e.startsWith("0x0");)e="0x".concat(e.slice(3));return e},W=function(e){return e.length%2==1&&(e=e.replace("0x","0x0")),e},C=function(){var e=u()(a.a.mark((function e(t,r,o){var c,u,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=function(e){if((e.nonce<0||e.gas<0||e.workNonce<0||e.chainId<0)&&(c=new Error("Nonce, gas, workNonce or chainId is lower than 0")),c)return o(c),Promise.reject(c);try{var t=n.extend.formatters.inputCallFormatter(e);t.to=t.to||"0x",t.data=t.data||"0x",t.value=t.value||"0x",t.chainId=n.utils.numberToHex(t.chainId);var a=P.a.encode([v.a.fromNat(t.nonce),v.a.fromNat(t.workNonce||"0x"),v.a.fromNat(t.gas),t.to.toLowerCase(),v.a.fromNat(t.value),t.data,v.a.fromNat(t.chainId||"0x1"),"0x","0x"]),i=x.a.keccak256(a),s=h.a.makeSigner(2*y.a.toNumber(t.chainId||"0x1")+35)(x.a.keccak256(a),r),l=P.a.decode(a).slice(0,6).concat(h.a.decodeSignature(s));l[6]=W(_(l[6])),l[7]=W(_(l[7])),l[8]=W(_(l[8]));var f=P.a.encode(l),p=P.a.decode(f);u={messageHash:i,v:_(p[6]),r:_(p[7]),s:_(p[8]),rawTransaction:f}}catch(e){return o(e),Promise.reject(e)}return o(null,u),u},c=!1,o=o||function(){},t){e.next=7;break}return c=new Error("No transaction object given!"),o(c),e.abrupt("return",Promise.reject(c));case 7:if(t.gasPrice="0",void 0===t.nonce||void 0===t.gas||void 0===t.workNonce||void 0===t.chainId){e.next=10;break}return e.abrupt("return",Promise.resolve(i(t)));case 10:return s=n.eth.accounts.privateKeyToAccount(r).address,e.abrupt("return",Promise.all([N(t.nonce)?n.eth.getTransactionCount(s):t.nonce,N(t.gas)?n.eth.estimateGas(t):t.gas,N(t.workNonce)?n.eth.calculateWorkForTransaction(T({},t,{from:s})):t,N(t.chainId)?n.eth.getChainId():t.chainId]).then((function(e){var r=d()(e,4),n=r[0],o=r[1],a=r[2].workNonce,c=r[3];if(N(n)||N(o)||N(a)||N(c))throw new Error("One of the values 'nonce=".concat(n,"', 'gas=").concat(o,"', 'workNonce=").concat(a,"' or 'chainId=").concat(c,"' couldn't be fetched"));return i(T({},t,{nonce:n,gas:o,workNonce:a,chainId:c}))})));case 12:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}();F=r(8).benchmarkWorkCallsPerSecond;var D,E=function(){var e=u()(a.a.mark((function e(){var t,r,n,o,c,u,i,s=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:2,r=s.length>1&&void 0!==s[1]?s[1]:21e3,(n=s.length>2?s[2]:void 0)||"function"==typeof(o=Array.prototype.slice.call(s))[o.length-1]&&(n=o.pop()),n=n||function(){},e.prev=5,e.next=8,F();case 8:return c=e.sent,u=Math.log2(t*r),u=Math.ceil(u),i=Number((u/c*1e4%60).toFixed(2)),n(null,i),e.abrupt("return",Promise.resolve(i));case 16:return e.prev=16,e.t0=e.catch(5),n(e.t0),e.abrupt("return",Promise.reject(e.t0));case 20:case"end":return e.stop()}}),e,null,[[5,16]])})));return function(){return e.apply(this,arguments)}}();D=r(8).createCalculateWorkForTransaction;var S=function(e){if(!e)throw new Error("No web3 object provided to web3-ebakus!");e.eth.extend({methods:[{name:"suggestDifficulty",call:"eth_suggestDifficulty",params:1,inputFormatter:[e.utils.toChecksumAddress],outputFormatter:e.utils.toFloat},{name:"getAbiForAddress",call:"eth_getAbiForAddress",params:1,inputFormatter:[e.utils.inputAddressFormatter]},{name:"getStaked",call:"eth_getStaked",params:2,inputFormatter:[e.utils.inputAddressFormatter,e.utils.inputBlockNumberFormatter]}]}),e.extend({property:"db",methods:[{name:"get",call:"db_get",params:5,inputFormatter:[e.utils.inputAddressFormatter,null,null,null,e.utils.inputBlockNumberFormatter]},{name:"select",call:"db_select",params:5,inputFormatter:[e.utils.inputAddressFormatter,null,null,null,e.utils.inputBlockNumberFormatter]},{name:"next",call:"db_next",params:1,inputFormatter:[null]},{name:"releaseIterator",call:"db_releaseIterator",params:1,inputFormatter:[null]}]});var t=D({suggestDifficulty:e.eth.suggestDifficulty,getTransactionCount:e.eth.getTransactionCount,estimateGas:e.eth.estimateGas,hexToNumber:e.utils.hexToNumber,numberToHex:e.utils.numberToHex,inputCallFormatter:e.extend.formatters.inputCallFormatter});e.eth.calculateWorkForTransaction=t,e.eth.estimatePoWTime=E;var r=e.eth.accounts.__proto__._addAccountFunctions;return e.eth.accounts.__proto__._addAccountFunctions=function(t){return(t=r.call(this,t)).signTransaction=function(e,r){return C(e,t.privateKey,r)},t.calculateWorkForTransaction=e.eth.calculateWorkForTransaction,t},e.eth.accounts.signTransaction=function(e,t,r){return C(e,t,r)},n=e,e};function I(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}r.d(t,"default",(function(){return A}));var q={defaultTargetDifficulty:null};function A(e){var t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?I(Object(r),!0).forEach((function(t){s()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):I(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},q,{},e),r=t.web3,n=t.defaultTargetDifficulty;this.web3=new S(r),this.defaultTargetDifficulty=n}Object(l.inherits)(A,p.a),A.prototype.handleRequest=function(){var e=u()(a.a.mark((function e(t,r,n){var o,c,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.method,e.next="eth_sendTransaction"===e.t0?3:"eth_signTransaction"===e.t0?3:"eth_getTransactionReceipt"===e.t0?20:22;break;case 3:if((o=t.params[0]).workNonce){e.next=18;break}return e.prev=5,e.next=8,this.web3.eth.calculateWorkForTransaction(o,this.defaultTargetDifficulty,null);case 8:c=e.sent,u=c.workNonce,t.params[0].workNonce=u,t.params[0].gasPrice=u,e.next=18;break;case 14:return e.prev=14,e.t1=e.catch(5),n(e.t1),e.abrupt("return");case 18:return r(),e.abrupt("return");case 20:return setTimeout((function(){r()}),2e3),e.abrupt("return");case 22:return r(),e.abrupt("return");case 24:case"end":return e.stop()}}),e,this,[[5,14]])})));return function(t,r,n){return e.apply(this,arguments)}}()}]).default}));