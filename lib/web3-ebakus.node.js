/*!
 * Extend Web3 for Ebakus Blockchain v0.1.7
 * 
 * @author Ebakus AG <hello@ebakus.com>
 * @website https://www.ebakus.com/
 * 
 * @copyright Ebakus 2020
 * @license MIT
 */
!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports["web3-ebakus"]=r():e.Web3Ebakus=r()}(this,(function(){return function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=24)}([function(e,r){e.exports=require("eth-lib/lib/bytes")},function(e,r){e.exports=require("eth-lib/lib/rlp")},function(e,r){e.exports=require("core-js/modules/es6.promise")},function(e,r){e.exports=require("core-js/modules/es6.object.to-string")},function(e,r){e.exports=require("regenerator-runtime/runtime")},function(e,r){e.exports=require("eth-lib/lib/account")},function(e,r){e.exports=require("eth-lib/lib/hash")},function(e,r,t){(function(r){e.exports=function(){return new r("./node_modules/web3-ebakus/lib/proofOfWork.node.worker.js")}}).call(this,t(22).Worker)},function(e,r){e.exports=require("core-js/modules/es6.regexp.to-string")},function(e,r){e.exports=require("core-js/modules/es7.symbol.async-iterator")},function(e,r){e.exports=require("core-js/modules/es6.symbol")},function(r,t,n){"use strict";n.r(t),n(9),n(10),n(4),n(2),n(8),n(3);var o,a=n(0),u=n.n(a),c=n(1),i=n.n(c),s=n(7),l=n.n(s),f=(n(23),function(e){return("string"==typeof e||"number"==typeof e)&&/^(-)?0x[0-9a-f]*$/i.test(e)});function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}n.d(t,"createCalculateWorkForTransaction",(function(){return m})),n.d(t,"benchmarkWorkCallsPerSecond",(function(){return d}));var m=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=function(r){return e.hexToNumber?e.hexToNumber(r):parseInt(r,16)},t=function(r){return e.numberToHex?e.numberToHex(r):"0x".concat(r.toString(16))};return function(n,o,a,c){var s=!1;return c=c||function(){},n?Promise.resolve(function(n){var s,m,d,b,g,h,x,y;return regeneratorRuntime.async((function(v){for(;;)switch(v.prev=v.next){case 0:if(s=0,m=!1,null!==a&&"object"===p(a)&&(a.isRunning=function(){return m},a.getCurrentWorkNonce=function(){return s},a.kill=function(){m=!1,s=0,d&&d.terminate(),b&&b("Worker terminated by user")}),v.prev=3,o){v.next=12;break}if(!e.suggestDifficulty){v.next=11;break}return v.next=8,regeneratorRuntime.awrap(e.suggestDifficulty(n.from));case 8:o=v.sent,v.next=12;break;case 11:g=new Error("Ebakus calculateWorkForTransaction - opts.suggestDifficulty not provided");case 12:if(n.nonce||g){v.next=20;break}if(!e.getTransactionCount){v.next=19;break}return v.next=16,regeneratorRuntime.awrap(e.getTransactionCount(n.from));case 16:n.nonce=v.sent,v.next=20;break;case 19:g=new Error("Ebakus calculateWorkForTransaction - opts.getTransactionCount not provided");case 20:if(n.gas||g){v.next=28;break}if(!e.estimateGas){v.next=27;break}return v.next=24,regeneratorRuntime.awrap(e.estimateGas(n));case 24:n.gas=v.sent,v.next=28;break;case 27:g=new Error("Ebakus calculateWorkForTransaction - opts.estimateGas not provided");case 28:if(!g){v.next=31;break}return c(g),v.abrupt("return",Promise.reject(g));case 31:return n.gasPrice="0",e.inputCallFormatter&&(n=e.inputCallFormatter(n)),h=i.a.encode([u.a.fromNat(n.nonce),u.a.fromNat(n.gas),n.to?n.to.toLowerCase():"",u.a.fromNat(n.value||"0x"),n.data||"0x"]),x=f(n.gas)?r(n.gas):n.gas,y={hash:h,targetDifficulty:o*x},v.abrupt("return",new Promise((function(e,r){d=new l.a,b=r,d.on("message",(function(r){var o=r.cmd,a=r.workNonce;switch(o){case"ready":m=!0,d.postMessage(y);break;case"current":s=a;break;case"finished":n.workNonce=t(a),s=n.workNonce,m=!1,d.terminate(),c(null,n),e(n);break;default:console.warn("Unknown data from worker",r)}})),d.on("error",(function(e){throw e})),d.on("exit",(function(e){if(1===e)return null;var r=new Error("Worker has stopped with code ".concat(e));return c(r),Promise.reject(r)}))})));case 39:return v.prev=39,v.t0=v.catch(3),c(v.t0),v.abrupt("return",Promise.reject(v.t0));case 43:case"end":return v.stop()}}),null,null,[[3,39]])}(n)):(s=new Error("No transaction object given!"),c(s),Promise.reject(s))}},d=function(r){return o&&o>0?Promise.resolve(o):(r=r||function(){},Promise.resolve(regeneratorRuntime.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,n={benchmark:!0},a.abrupt("return",new Promise((function(a){(t=new l.a).on("message",(function(u){var c=u.cmd,i=u.callsPerSecond;switch(c){case"ready":t.postMessage(n);break;case"finished":t.terminate(),o=i,r(null,i),a(i);break;default:console.warn("Unknown data from worker",e.data)}})),t.on("error",(function(e){throw e})),t.on("exit",(function(e){if(1===e)return null;var t=new Error("Worker has stopped with code ".concat(e));return r(t),Promise.reject(t)}))})));case 5:return a.prev=5,a.t0=a.catch(0),r(a.t0),a.abrupt("return",Promise.reject(a.t0));case 9:case"end":return a.stop()}}),null,null,[[0,5]])));var t,n}},function(e,r){e.exports=require("eth-lib/lib/nat")},function(e,r){e.exports=require("core-js/modules/es7.object.get-own-property-descriptors")},function(e,r){e.exports=require("core-js/modules/es6.object.keys")},function(e,r){e.exports=require("core-js/modules/web.dom.iterable")},function(e,r){e.exports=require("core-js/modules/es6.array.iterator")},function(e,r){e.exports=require("core-js/modules/es6.string.iterator")},function(e,r){e.exports=require("core-js/modules/es6.regexp.replace")},function(e,r){e.exports=require("core-js/modules/es6.string.starts-with")},function(e,r){e.exports=require("core-js/modules/es6.number.constructor")},function(e,r){e.exports=require("core-js/modules/es6.math.log2")},function(e,r){e.exports=require("worker_threads")},function(e,r){e.exports=require("core-js/modules/es6.typed.uint8-array")},function(e,r,t){"use strict";t.r(r),t(8),t(9),t(13),t(10),t(14),t(15),t(16),t(17),t(2),t(3),t(4),t(18),t(19);var n,o=t(5),a=t.n(o),u=t(0),c=t.n(u),i=t(6),s=t.n(i),l=t(12),f=t.n(l),p=t(1),m=t.n(p);function d(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function b(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?d(Object(t),!0).forEach((function(r){g(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):d(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function g(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var h,x=function(e){return null==e},y=function(e){for(;e&&e.startsWith("0x0");)e="0x".concat(e.slice(3));return e},v=function(e){return e.length%2==1&&(e=e.replace("0x","0x0")),e},k=function(e,r,t){var o,u,i,l;return regeneratorRuntime.async((function(p){for(;;)switch(p.prev=p.next){case 0:if(i=function(e){if((e.nonce<0||e.gas<0||e.workNonce<0||e.chainId<0)&&(o=new Error("Nonce, gas, workNonce or chainId is lower than 0")),o)return t(o),Promise.reject(o);try{var i=n.extend.formatters.inputCallFormatter(e);i.to=i.to||"0x",i.data=i.data||"0x",i.value=i.value||"0x",i.chainId=n.utils.numberToHex(i.chainId);var l=m.a.encode([c.a.fromNat(i.nonce),c.a.fromNat(i.workNonce||"0x"),c.a.fromNat(i.gas),i.to.toLowerCase(),c.a.fromNat(i.value),i.data,c.a.fromNat(i.chainId||"0x1"),"0x","0x"]),p=s.a.keccak256(l),d=a.a.makeSigner(2*f.a.toNumber(i.chainId||"0x1")+35)(s.a.keccak256(l),r),b=m.a.decode(l).slice(0,6).concat(a.a.decodeSignature(d));b[6]=v(y(b[6])),b[7]=v(y(b[7])),b[8]=v(y(b[8]));var g=m.a.encode(b),h=m.a.decode(g);u={messageHash:p,v:y(h[6]),r:y(h[7]),s:y(h[8]),rawTransaction:g}}catch(e){return t(e),Promise.reject(e)}return t(null,u),u},o=!1,t=t||function(){},e){p.next=7;break}return o=new Error("No transaction object given!"),t(o),p.abrupt("return",Promise.reject(o));case 7:if(e.gasPrice="0",void 0===e.nonce||void 0===e.gas||void 0===e.workNonce||void 0===e.chainId){p.next=10;break}return p.abrupt("return",Promise.resolve(i(e)));case 10:return l=n.eth.accounts.privateKeyToAccount(r).address,p.abrupt("return",Promise.all([x(e.nonce)?n.eth.getTransactionCount(l):e.nonce,x(e.gas)?n.eth.estimateGas(e):e.gas,x(e.workNonce)?n.eth.calculateWorkForTransaction(b({},e,{from:l})):e,x(e.chainId)?n.eth.getChainId():e.chainId]).then((function(r){var t,n,o=(n=4,function(e){if(Array.isArray(e))return e}(t=r)||function(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],n=!0,o=!1,a=void 0;try{for(var u,c=e[Symbol.iterator]();!(n=(u=c.next()).done)&&(t.push(u.value),!r||t.length!==r);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==c.return||c.return()}finally{if(o)throw a}}return t}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()),a=o[0],u=o[1],c=o[2].workNonce,s=o[3];if(x(a)||x(u)||x(c)||x(s))throw new Error("One of the values 'nonce=".concat(a,"', 'gas=").concat(u,"', 'workNonce=").concat(c,"' or 'chainId=").concat(s,"' couldn't be fetched"));return i(b({},e,{nonce:a,gas:u,workNonce:c,chainId:s}))})));case 12:case"end":return p.stop()}}))};t(20),t(21),h=t(11).benchmarkWorkCallsPerSecond;var w,j=function(){var e,r,t,n,o,a,u,c=arguments;return regeneratorRuntime.async((function(i){for(;;)switch(i.prev=i.next){case 0:return e=c.length>0&&void 0!==c[0]?c[0]:2,r=c.length>1&&void 0!==c[1]?c[1]:21e3,(t=c.length>2?c[2]:void 0)||"function"==typeof(n=Array.prototype.slice.call(c))[n.length-1]&&(t=n.pop()),t=t||function(){},i.prev=5,i.next=8,regeneratorRuntime.awrap(h());case 8:return o=i.sent,a=Math.log2(e*r),a=Math.ceil(a),u=Number((a/o*1e4%60).toFixed(2)),t(null,u),i.abrupt("return",Promise.resolve(u));case 16:return i.prev=16,i.t0=i.catch(5),t(i.t0),i.abrupt("return",Promise.reject(i.t0));case 20:case"end":return i.stop()}}),null,null,[[5,16]])};w=t(11).createCalculateWorkForTransaction,r.default=function(e){if(!e)throw new Error("No web3 object provided to web3-ebakus!");e.eth.extend({methods:[{name:"suggestDifficulty",call:"eth_suggestDifficulty",params:1,inputFormatter:[e.utils.toChecksumAddress],outputFormatter:e.utils.toFloat},{name:"getAbiForAddress",call:"eth_getAbiForAddress",params:1,inputFormatter:[e.utils.inputAddressFormatter]},{name:"getStaked",call:"eth_getStaked",params:2,inputFormatter:[e.utils.inputAddressFormatter,e.utils.inputBlockNumberFormatter]}]}),e.extend({property:"db",methods:[{name:"get",call:"db_get",params:5,inputFormatter:[e.utils.inputAddressFormatter,null,null,null,e.utils.inputBlockNumberFormatter]},{name:"select",call:"db_select",params:5,inputFormatter:[e.utils.inputAddressFormatter,null,null,null,e.utils.inputBlockNumberFormatter]},{name:"next",call:"db_next",params:1,inputFormatter:[null]},{name:"releaseIterator",call:"db_releaseIterator",params:1,inputFormatter:[null]}]});var r=w({suggestDifficulty:e.eth.suggestDifficulty,getTransactionCount:e.eth.getTransactionCount,estimateGas:e.eth.estimateGas,hexToNumber:e.utils.hexToNumber,numberToHex:e.utils.numberToHex,inputCallFormatter:e.extend.formatters.inputCallFormatter});e.eth.calculateWorkForTransaction=r,e.eth.estimatePoWTime=j;var t=e.eth.accounts.__proto__._addAccountFunctions;return e.eth.accounts.__proto__._addAccountFunctions=function(r){return(r=t.call(this,r)).signTransaction=function(e,t){return k(e,r.privateKey,t)},r.calculateWorkForTransaction=e.eth.calculateWorkForTransaction,r},e.eth.accounts.signTransaction=function(e,r,t){return k(e,r,t)},n=e,e}}]).default}));